#include "speed_encoder.h"

/* ??????(????) */
__IO Encoder_StateTypeDef g_speed_encoder_state = ENCODER_STATE_IDLE;
__IO Speed_Encoder_t g_speed_encoder[SPEED_ENCODER_NUM] = {
    { &htim2, 0, 0.0f },  // ??????(TIM2)
    { &htim4, 0, 0.0f }   // ??????(TIM4)
};

/* ?????? */
void Speed_Encoder_Init(void)
{
    for (int i = 0; i < SPEED_ENCODER_NUM; i++) {
        // ?????
        __HAL_TIM_SET_COUNTER(g_speed_encoder[i].timer, 0);
        // ???????
        HAL_TIM_Encoder_Start(g_speed_encoder[i].timer, TIM_CHANNEL_ALL);
    }
    g_speed_encoder_state = ENCODER_STATE_IDLE;
}

/* ????????(????????) */
void Speed_Encoder_Update(void)
{
    for (int i = 0; i < SPEED_ENCODER_NUM; i++) {
        // ???????
        g_speed_encoder[i].counter = __HAL_TIM_GET_COUNTER(g_speed_encoder[i].timer);
        // ?????(??????)
        __HAL_TIM_SET_COUNTER(g_speed_encoder[i].timer, 0);
    }
    // ????????
    g_speed_encoder_state = ENCODER_STATE_CAL_SPEED;
}

/* ????(??????????) */
void Speed_Calculate(void)
{
    // ???????(?????????????)
    g_speed_encoder[0].speed = (float)g_speed_encoder[0].counter * SPEED_COEFF / 10000.0f;
    // ???????(??????????,??????????)
    g_speed_encoder[1].speed = (float)g_speed_encoder[1].counter * (-SPEED_COEFF) / 10000.0f;
}

/* ???????(?????) */
void Speed_Process(void)
{
    if (g_speed_encoder_state == ENCODER_STATE_CAL_SPEED) {
        // ????
        Speed_Calculate();
        // ??????
        g_speed_encoder_state = ENCODER_STATE_IDLE;
    }
}